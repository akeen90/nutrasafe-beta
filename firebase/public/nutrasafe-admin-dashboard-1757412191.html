<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NutraSafe Admin - Fast Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <style>
        /* Critical CSS - loaded synchronously */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #000000;
            --bg-secondary: #0a0e1a;
            --bg-tertiary: #1a1f2e;
            --accent: #00ff88;
            --accent-blue: #00d4ff;
            --text-primary: #ffffff;
            --text-secondary: #a0a6b8;
            --border: #2d3748;
            --shadow: 0 0 20px rgba(0, 255, 136, 0.15);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            margin: 0;
            overflow: hidden;
        }

        .app {
            height: 100vh;
            display: grid;
            grid-template-rows: 50px 1fr;
            grid-template-columns: 250px 1fr;
        }

        .header {
            grid-column: 1 / -1;
            background: var(--bg-secondary);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            border-bottom: 1px solid var(--border);
        }

        .logo {
            color: var(--accent);
            font-weight: 700;
            font-size: 16px;
        }

        .nav {
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            overflow-y: auto;
        }

        .nav-item {
            display: block;
            padding: 12px 20px;
            color: var(--text-secondary);
            text-decoration: none;
            transition: all 0.15s ease;
            cursor: pointer;
        }

        .nav-item:hover,
        .nav-item.active {
            background: var(--bg-tertiary);
            color: var(--accent);
            border-right: 2px solid var(--accent);
        }

        .main {
            background: var(--bg-primary);
            overflow: hidden;
            position: relative;
        }

        /* Loading States */
        .skeleton {
            background: linear-gradient(90deg, var(--bg-tertiary) 25%, var(--bg-secondary) 50%, var(--bg-tertiary) 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .skeleton-row {
            height: 60px;
            margin-bottom: 8px;
            border-radius: 4px;
        }

        /* Virtual Scroller */
        .virtual-scroller {
            height: 100%;
            overflow-y: auto;
            position: relative;
        }

        .virtual-content {
            position: relative;
        }

        .virtual-item {
            position: absolute;
            left: 0;
            right: 0;
            display: flex;
            align-items: center;
            padding: 12px 20px;
            border-bottom: 1px solid var(--border);
            background: var(--bg-secondary);
            transition: background 0.15s ease;
        }

        .virtual-item:hover {
            background: var(--bg-tertiary);
        }

        /* Food Item Styles */
        .food-item {
            display: flex;
            align-items: center;
            gap: 12px;
            width: 100%;
        }

        .food-image {
            width: 40px;
            height: 40px;
            border-radius: 4px;
            object-fit: cover;
            background: var(--bg-tertiary);
        }

        .food-info {
            flex: 1;
            min-width: 0;
        }

        .food-name {
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .food-meta {
            color: var(--text-secondary);
            font-size: 12px;
            margin-top: 2px;
        }

        .food-actions {
            display: flex;
            gap: 8px;
        }

        .btn {
            padding: 4px 8px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.15s ease;
        }

        .btn-primary {
            background: var(--accent);
            color: black;
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .btn:hover {
            transform: translateY(-1px);
        }

        /* Search */
        .search-container {
            padding: 20px;
            border-bottom: 1px solid var(--border);
        }

        .search-input {
            width: 100%;
            padding: 10px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--text-primary);
            font-size: 14px;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(0, 255, 136, 0.2);
        }

        /* Status indicators */
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 6px;
        }

        .status-verified { background: var(--accent); }
        .status-pending { background: #ffd700; }
        .status-issue { background: #ff4757; }

        /* Performance indicators */
        .perf-indicator {
            position: fixed;
            top: 60px;
            right: 20px;
            background: var(--bg-tertiary);
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 11px;
            font-family: monospace;
            z-index: 1000;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .app {
                grid-template-columns: 1fr;
                grid-template-rows: 50px 50px 1fr;
            }
            
            .nav {
                grid-row: 2;
                grid-column: 1;
                display: flex;
                overflow-x: auto;
            }
            
            .nav-item {
                white-space: nowrap;
            }
        }
    </style>
</head>
<body>
    <div class="app">
        <header class="header">
            <div class="logo">🥗 NutraSafe Admin</div>
            <div id="metrics" style="font-family: monospace; font-size: 12px;"></div>
        </header>

        <nav class="nav">
            <a href="#foods" class="nav-item active" data-view="foods">Foods Database</a>
            <a href="#users" class="nav-item" data-view="users">Users</a>
            <a href="#analytics" class="nav-item" data-view="analytics">Analytics</a>
            <a href="#cleanse" class="nav-item" data-view="cleanse">AI Cleanse</a>
            <a href="#settings" class="nav-item" data-view="settings">Settings</a>
        </nav>

        <main class="main">
            <div id="app-content">
                <!-- Dynamic content will be inserted here -->
            </div>
        </main>
    </div>

    <!-- Performance indicator -->
    <div class="perf-indicator" id="perf">
        FPS: <span id="fps">--</span> | 
        Items: <span id="item-count">0</span> | 
        Mem: <span id="memory">--</span>
    </div>

    <script>
        // Meta-level Performance Core
        class MetaPerf {
            constructor() {
                this.fps = 0;
                this.frameCount = 0;
                this.lastTime = performance.now();
                this.startMonitoring();
            }

            startMonitoring() {
                const updateFPS = () => {
                    this.frameCount++;
                    const now = performance.now();
                    if (now >= this.lastTime + 1000) {
                        this.fps = Math.round((this.frameCount * 1000) / (now - this.lastTime));
                        this.frameCount = 0;
                        this.lastTime = now;
                        this.updateDisplay();
                    }
                    requestAnimationFrame(updateFPS);
                };
                updateFPS();
            }

            updateDisplay() {
                document.getElementById('fps').textContent = this.fps;
                if (performance.memory) {
                    const mb = Math.round(performance.memory.usedJSHeapSize / 1024 / 1024);
                    document.getElementById('memory').textContent = mb + 'MB';
                }
            }
        }

        // Virtual Scroller - Meta-style Performance
        class VirtualScroller {
            constructor(container, itemHeight = 60, bufferSize = 10) {
                this.container = container;
                this.itemHeight = itemHeight;
                this.bufferSize = bufferSize;
                this.items = [];
                this.visibleItems = new Map();
                this.scrollTop = 0;
                this.containerHeight = container.clientHeight;
                
                this.setupScrolling();
                this.createContent();
            }

            setupScrolling() {
                this.container.addEventListener('scroll', this.onScroll.bind(this), { passive: true });
                window.addEventListener('resize', this.onResize.bind(this));
            }

            createContent() {
                this.content = document.createElement('div');
                this.content.className = 'virtual-content';
                this.container.appendChild(this.content);
            }

            setItems(items) {
                this.items = items;
                this.content.style.height = `${items.length * this.itemHeight}px`;
                this.render();
                document.getElementById('item-count').textContent = items.length;
            }

            onScroll() {
                this.scrollTop = this.container.scrollTop;
                this.render();
            }

            onResize() {
                this.containerHeight = this.container.clientHeight;
                this.render();
            }

            render() {
                const startIndex = Math.max(0, Math.floor(this.scrollTop / this.itemHeight) - this.bufferSize);
                const endIndex = Math.min(
                    this.items.length - 1,
                    Math.ceil((this.scrollTop + this.containerHeight) / this.itemHeight) + this.bufferSize
                );

                // Remove items that are no longer visible
                for (const [index, element] of this.visibleItems) {
                    if (index < startIndex || index > endIndex) {
                        element.remove();
                        this.visibleItems.delete(index);
                    }
                }

                // Add new visible items
                for (let i = startIndex; i <= endIndex; i++) {
                    if (!this.visibleItems.has(i) && this.items[i]) {
                        const element = this.createItemElement(this.items[i], i);
                        this.content.appendChild(element);
                        this.visibleItems.set(i, element);
                    }
                }
            }

            createItemElement(item, index) {
                const element = document.createElement('div');
                element.className = 'virtual-item';
                element.style.top = `${index * this.itemHeight}px`;
                element.style.height = `${this.itemHeight}px`;
                element.innerHTML = this.renderItem(item, index);
                return element;
            }

            renderItem(item, index) {
                return `
                    <div class="food-item">
                        <img class="food-image" src="${item.image || '/api/placeholder/40/40'}" alt="${item.name}" loading="lazy">
                        <div class="food-info">
                            <div class="food-name">${item.name}</div>
                            <div class="food-meta">
                                <span class="status-dot ${item.verified ? 'status-verified' : 'status-pending'}"></span>
                                ${item.brand || 'Unknown Brand'} • ${item.category || 'Uncategorized'}
                            </div>
                        </div>
                        <div class="food-actions">
                            <button class="btn btn-primary" onclick="app.editFood('${item.id}')">Edit</button>
                            <button class="btn btn-secondary" onclick="app.deleteFood('${item.id}')">Delete</button>
                        </div>
                    </div>
                `;
            }
        }

        // Smart Cache System
        class SmartCache {
            constructor() {
                this.cache = new Map();
                this.timestamps = new Map();
                this.maxAge = 5 * 60 * 1000; // 5 minutes
            }

            get(key) {
                if (!this.cache.has(key)) return null;
                
                const timestamp = this.timestamps.get(key);
                if (Date.now() - timestamp > this.maxAge) {
                    this.cache.delete(key);
                    this.timestamps.delete(key);
                    return null;
                }
                
                return this.cache.get(key);
            }

            set(key, value) {
                this.cache.set(key, value);
                this.timestamps.set(key, Date.now());
            }

            clear() {
                this.cache.clear();
                this.timestamps.clear();
            }
        }

        // Main App Class - Meta-style Architecture
        class AdminApp {
            constructor() {
                this.cache = new SmartCache();
                this.perf = new MetaPerf();
                this.currentView = 'foods';
                this.foods = [];
                this.filteredFoods = [];
                this.searchTerm = '';
                this.cleanseInProgress = false;
                this.cleanseProgress = {
                    processed: 0,
                    total: 0,
                    cost: 0,
                    issues: 0
                };
                
                this.init();
            }

            async init() {
                this.setupNavigation();
                this.setupSearch();
                await this.loadView('foods');
            }

            setupNavigation() {
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.addEventListener('click', (e) => {
                        e.preventDefault();
                        const view = item.dataset.view;
                        this.switchView(view);
                    });
                });
            }

            setupSearch() {
                let searchTimeout;
                const searchInput = document.createElement('input');
                searchInput.className = 'search-input';
                searchInput.placeholder = 'Search foods...';
                searchInput.addEventListener('input', (e) => {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => {
                        this.searchTerm = e.target.value.toLowerCase();
                        this.filterFoods();
                    }, 150); // Debounced search
                });
                
                return searchInput;
            }

            switchView(view) {
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.toggle('active', item.dataset.view === view);
                });
                
                this.currentView = view;
                this.loadView(view);
            }

            async loadView(view) {
                const content = document.getElementById('app-content');
                
                switch(view) {
                    case 'foods':
                        await this.loadFoodsView(content);
                        break;
                    case 'cleanse':
                        await this.loadCleanseView(content);
                        break;
                    case 'analytics':
                        await this.loadAnalyticsView(content);
                        break;
                    default:
                        content.innerHTML = `<div style="padding: 20px;">View: ${view} - Coming Soon</div>`;
                }
            }

            async loadFoodsView(container) {
                // Show loading skeletons immediately
                this.showLoadingSkeletons(container);
                
                // Try cache first
                let foods = this.cache.get('foods');
                if (!foods) {
                    foods = await this.fetchFoods();
                    this.cache.set('foods', foods);
                }
                
                this.foods = foods;
                this.filteredFoods = [...foods];
                
                // Create the foods interface
                const searchContainer = document.createElement('div');
                searchContainer.className = 'search-container';
                searchContainer.appendChild(this.setupSearch());
                
                const scrollerContainer = document.createElement('div');
                scrollerContainer.className = 'virtual-scroller';
                scrollerContainer.style.height = 'calc(100% - 80px)';
                
                container.innerHTML = '';
                container.appendChild(searchContainer);
                container.appendChild(scrollerContainer);
                
                // Initialize virtual scroller
                this.scroller = new VirtualScroller(scrollerContainer);
                this.scroller.setItems(this.filteredFoods);
            }

            showLoadingSkeletons(container) {
                const skeletons = Array.from({length: 15}, () => 
                    '<div class="skeleton skeleton-row"></div>'
                ).join('');
                
                container.innerHTML = `
                    <div class="search-container">
                        <div class="skeleton" style="height: 40px; border-radius: 4px;"></div>
                    </div>
                    <div style="padding: 20px;">
                        ${skeletons}
                    </div>
                `;
            }

            async fetchFoods() {
                try {
                    const response = await fetch('/api/foods');
                    if (!response.ok) throw new Error('Failed to fetch foods');
                    return await response.json();
                } catch (error) {
                    console.error('Error fetching foods:', error);
                    // Return mock data for demo
                    return this.generateMockFoods(1000);
                }
            }

            generateMockFoods(count) {
                const brands = ['Tesco', 'Sainsburys', 'ASDA', 'Morrisons', 'Co-op'];
                const categories = ['Dairy', 'Meat', 'Vegetables', 'Fruits', 'Snacks'];
                const names = ['Organic Milk', 'Chicken Breast', 'Broccoli', 'Bananas', 'Crisps'];
                
                return Array.from({length: count}, (_, i) => ({
                    id: `food-${i}`,
                    name: `${names[i % names.length]} ${i + 1}`,
                    brand: brands[i % brands.length],
                    category: categories[i % categories.length],
                    verified: Math.random() > 0.3,
                    image: null
                }));
            }

            filterFoods() {
                if (!this.searchTerm) {
                    this.filteredFoods = [...this.foods];
                } else {
                    this.filteredFoods = this.foods.filter(food => 
                        food.name.toLowerCase().includes(this.searchTerm) ||
                        (food.brand && food.brand.toLowerCase().includes(this.searchTerm))
                    );
                }
                
                if (this.scroller) {
                    this.scroller.setItems(this.filteredFoods);
                }
            }

            async loadCleanseView(container) {
                container.innerHTML = `
                    <div style="padding: 20px;">
                        <h2 style="color: var(--accent); margin-bottom: 20px;">🧹 AI Food Cleanse</h2>
                        
                        <!-- Controls Section -->
                        <div style="background: var(--bg-secondary); padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                            <h3 style="margin-bottom: 15px;">Cleanse Settings</h3>
                            <div style="display: grid; gap: 15px; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
                                <div>
                                    <label style="display: block; margin-bottom: 5px;">Batch Size:</label>
                                    <input type="number" id="batch-size" value="50" min="1" max="100" 
                                           style="width: 100%; padding: 8px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 4px; color: var(--text-primary);">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px;">Analysis Type:</label>
                                    <select id="analysis-type" 
                                            style="width: 100%; padding: 8px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 4px; color: var(--text-primary);">
                                        <option value="comprehensive">Comprehensive Analysis</option>
                                        <option value="quick">Quick Analysis</option>
                                        <option value="allergens-only">Allergens Only</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div style="display: grid; gap: 20px; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); margin-bottom: 20px;">
                            <div style="background: var(--bg-secondary); padding: 20px; border-radius: 8px;">
                                <h3>Quick Cleanse (100 Foods)</h3>
                                <p style="color: var(--text-secondary); margin: 10px 0;">Test AI analysis on 100 random foods</p>
                                <button class="btn btn-primary" id="quick-cleanse-btn" onclick="app.runQuickCleanse()" 
                                        style="padding: 10px 20px; font-size: 14px;">Start Quick Cleanse</button>
                            </div>
                            <div style="background: var(--bg-secondary); padding: 20px; border-radius: 8px;">
                                <h3>Full Database Cleanse</h3>
                                <p style="color: var(--text-secondary); margin: 10px 0;">Analyze all unverified foods in database</p>
                                <button class="btn btn-primary" id="full-cleanse-btn" onclick="app.runFullCleanse()" 
                                        style="padding: 10px 20px; font-size: 14px;">Start Full Cleanse</button>
                            </div>
                        </div>

                        <!-- Progress Section -->
                        <div style="background: var(--bg-secondary); padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                            <h3 style="margin-bottom: 15px;">🔄 Progress Monitor</h3>
                            <div id="cleanse-status" style="color: var(--text-secondary); margin-bottom: 10px;">Ready to start cleansing...</div>
                            <div style="background: var(--bg-tertiary); border-radius: 6px; height: 10px; margin: 10px 0;">
                                <div id="progress-bar" style="background: var(--accent); height: 100%; border-radius: 6px; width: 0%; transition: width 0.3s;"></div>
                            </div>
                            <div style="display: grid; gap: 10px; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); font-family: monospace; font-size: 12px;">
                                <div>Processed: <span id="processed-count" style="color: var(--accent);">0</span></div>
                                <div>Total: <span id="total-count" style="color: var(--text-secondary);">0</span></div>
                                <div>Issues Found: <span id="issues-count" style="color: #ff4757;">0</span></div>
                                <div>Cost: $<span id="cost-estimate" style="color: var(--accent-blue);">0.00</span></div>
                            </div>
                            <div style="margin-top: 10px;">
                                <button class="btn btn-secondary" id="stop-cleanse-btn" onclick="app.stopCleanse()" 
                                        style="padding: 6px 12px; font-size: 12px;" disabled>Stop Cleanse</button>
                                <button class="btn btn-secondary" id="view-results-btn" onclick="app.viewCleanseResults()" 
                                        style="padding: 6px 12px; font-size: 12px; margin-left: 10px;" disabled>View Results</button>
                            </div>
                        </div>

                        <!-- Activity Log -->
                        <div style="background: var(--bg-secondary); padding: 20px; border-radius: 8px;">
                            <h3 style="margin-bottom: 15px;">📝 Activity Log</h3>
                            <div id="activity-log" style="max-height: 300px; overflow-y: auto; font-family: monospace; font-size: 12px; background: var(--bg-tertiary); border-radius: 4px; padding: 10px;">
                                <div style="color: var(--text-secondary);">No activity yet. Start a cleanse operation to see logs here.</div>
                            </div>
                        </div>
                    </div>
                `;
            }

            async loadAnalyticsView(container) {
                container.innerHTML = `
                    <div style="padding: 20px;">
                        <h2 style="color: var(--accent); margin-bottom: 20px;">Analytics Dashboard</h2>
                        <div style="display: grid; gap: 20px; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));">
                            <div style="background: var(--bg-secondary); padding: 20px; border-radius: 8px;">
                                <h3>Total Foods</h3>
                                <div style="font-size: 32px; color: var(--accent); font-weight: bold;">${this.foods.length || 0}</div>
                            </div>
                            <div style="background: var(--bg-secondary); padding: 20px; border-radius: 8px;">
                                <h3>Verified Foods</h3>
                                <div style="font-size: 32px; color: var(--accent); font-weight: bold;">
                                    ${this.foods.filter(f => f.verified).length || 0}
                                </div>
                            </div>
                            <div style="background: var(--bg-secondary); padding: 20px; border-radius: 8px;">
                                <h3>Pending Review</h3>
                                <div style="font-size: 32px; color: #ffd700; font-weight: bold;">
                                    ${this.foods.filter(f => !f.verified).length || 0}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            // Food Actions
            editFood(id) {
                console.log('Edit food:', id);
                // Implement food editing modal
            }

            deleteFood(id) {
                console.log('Delete food:', id);
                // Implement optimistic delete
                const index = this.filteredFoods.findIndex(f => f.id === id);
                if (index !== -1) {
                    this.filteredFoods.splice(index, 1);
                    this.scroller.setItems(this.filteredFoods);
                }
            }

            async runQuickCleanse() {
                await this.startCleanse(100);
            }

            async runFullCleanse() {
                await this.startCleanse(-1); // -1 means all foods
            }

            async startCleanse(maxFoods = -1) {
                if (this.cleanseInProgress) return;

                const batchSize = parseInt(document.getElementById('batch-size').value) || 50;
                const analysisType = document.getElementById('analysis-type').value;

                // Get foods to cleanse
                let foodsToProcess = [...this.foods];
                if (maxFoods > 0) {
                    foodsToProcess = foodsToProcess.slice(0, maxFoods);
                }

                if (foodsToProcess.length === 0) {
                    this.logActivity('❌ No foods to process', 'error');
                    return;
                }

                const estimatedCost = (foodsToProcess.length * 0.002).toFixed(2);
                const confirmMessage = `Start AI cleanse of ${foodsToProcess.length} foods?\n\nBatch size: ${batchSize}\nAnalysis type: ${analysisType}\nEstimated cost: $${estimatedCost}`;

                if (!confirm(confirmMessage)) return;

                this.cleanseInProgress = true;
                this.cleanseProgress = {
                    processed: 0,
                    total: foodsToProcess.length,
                    cost: 0,
                    issues: 0
                };

                // Update UI
                document.getElementById('quick-cleanse-btn').disabled = true;
                document.getElementById('full-cleanse-btn').disabled = true;
                document.getElementById('stop-cleanse-btn').disabled = false;
                
                this.updateCleanseProgress();
                this.logActivity('🚀 AI cleanse started', 'info');

                try {
                    // Process in batches
                    const batches = [];
                    for (let i = 0; i < foodsToProcess.length; i += batchSize) {
                        batches.push(foodsToProcess.slice(i, i + batchSize));
                    }

                    for (let i = 0; i < batches.length && this.cleanseInProgress; i++) {
                        const batch = batches[i];
                        this.logActivity(`📦 Processing batch ${i + 1}/${batches.length} (${batch.length} foods)`, 'info');
                        
                        await this.processBatch(batch, analysisType);
                        
                        this.cleanseProgress.processed += batch.length;
                        this.updateCleanseProgress();

                        // Small delay between batches
                        await new Promise(resolve => setTimeout(resolve, 1000));
                    }

                    this.logActivity(`✅ Cleanse completed! Processed ${this.cleanseProgress.processed} foods`, 'success');
                    document.getElementById('view-results-btn').disabled = false;

                } catch (error) {
                    this.logActivity(`❌ Error during cleanse: ${error.message}`, 'error');
                } finally {
                    this.cleanseInProgress = false;
                    document.getElementById('quick-cleanse-btn').disabled = false;
                    document.getElementById('full-cleanse-btn').disabled = false;
                    document.getElementById('stop-cleanse-btn').disabled = true;
                }
            }

            async processBatch(foods, analysisType) {
                try {
                    const response = await fetch('https://us-central1-nutrasafe-705c7.cloudfunctions.net/analyzeAndCleanFoods', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            foods: foods,
                            analysisType: analysisType
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    const result = await response.json();
                    
                    // Update progress with results
                    if (result.issuesFound) {
                        this.cleanseProgress.issues += result.issuesFound;
                    }
                    if (result.cost) {
                        this.cleanseProgress.cost += result.cost;
                    }

                    this.logActivity(`✅ Batch processed: ${result.issuesFound || 0} issues found, $${(result.cost || 0).toFixed(4)} cost`, 'success');

                } catch (error) {
                    this.logActivity(`❌ Batch failed: ${error.message}`, 'error');
                    throw error;
                }
            }

            stopCleanse() {
                if (this.cleanseInProgress) {
                    this.cleanseInProgress = false;
                    this.logActivity('⏹️ Cleanse stopped by user', 'warning');
                }
            }

            updateCleanseProgress() {
                const progress = this.cleanseProgress;
                const percentage = progress.total > 0 ? (progress.processed / progress.total) * 100 : 0;

                document.getElementById('cleanse-status').textContent = 
                    this.cleanseInProgress ? 
                    `Processing... ${progress.processed}/${progress.total} foods` : 
                    'Ready to start cleansing...';

                document.getElementById('progress-bar').style.width = `${percentage}%`;
                document.getElementById('processed-count').textContent = progress.processed;
                document.getElementById('total-count').textContent = progress.total;
                document.getElementById('issues-count').textContent = progress.issues;
                document.getElementById('cost-estimate').textContent = progress.cost.toFixed(4);
            }

            logActivity(message, type = 'info') {
                const log = document.getElementById('activity-log');
                const timestamp = new Date().toLocaleTimeString();
                const colors = {
                    info: 'var(--text-primary)',
                    success: 'var(--accent)',
                    warning: '#ffd700',
                    error: '#ff4757'
                };

                const entry = document.createElement('div');
                entry.style.color = colors[type] || colors.info;
                entry.style.marginBottom = '2px';
                entry.textContent = `[${timestamp}] ${message}`;

                if (log.children.length === 1 && log.children[0].textContent.includes('No activity yet')) {
                    log.innerHTML = '';
                }

                log.appendChild(entry);
                log.scrollTop = log.scrollHeight;
            }

            viewCleanseResults() {
                this.logActivity('📊 Opening results view...', 'info');
                // TODO: Implement results viewer
                alert('Results viewer coming soon! Check the activity log for detailed results.');
            }
        }

        // Initialize the app when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            window.app = new AdminApp();
        });

        // Service Worker Registration for offline functionality
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js').catch(err => {
                console.log('SW registration failed:', err);
            });
        }
    </script>
</body>
</html>