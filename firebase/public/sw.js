const CACHE_NAME="nutrasafe-admin-v1",STATIC_CACHE="nutrasafe-static-v1",API_CACHE="nutrasafe-api-v1",CRITICAL_RESOURCES=["/admin-fast.html","/favicon.ico"],API_ENDPOINTS=["/api/foods","/api/users","/api/analytics"];async function handleApiRequest(e){const n=await caches.open(API_CACHE);try{const t=await fetch(e);return t.ok&&n.put(e,t.clone()),t}catch(t){console.log("SW: Network failed, trying cache:",e.url);const a=await n.match(e);return a||new Response(JSON.stringify({error:"Offline",message:"This data is not available offline",cached:!1}),{status:503,headers:{"Content-Type":"application/json"}})}}async function handlePageRequest(e){try{return await fetch(e)}catch(e){const n=await caches.open(STATIC_CACHE),t=await n.match("/admin-fast.html");return t||new Response('\n            <!DOCTYPE html>\n            <html>\n            <head>\n                <title>NutraSafe Admin - Offline</title>\n                <meta charset="UTF-8">\n                <meta name="viewport" content="width=device-width, initial-scale=1.0">\n                <style>\n                    body {\n                        font-family: -apple-system, BlinkMacSystemFont, \'Segoe UI\', system-ui, sans-serif;\n                        background: #000;\n                        color: #fff;\n                        display: flex;\n                        align-items: center;\n                        justify-content: center;\n                        height: 100vh;\n                        margin: 0;\n                        text-align: center;\n                    }\n                    .offline-container {\n                        max-width: 400px;\n                        padding: 40px;\n                    }\n                    .offline-icon {\n                        font-size: 64px;\n                        margin-bottom: 20px;\n                    }\n                    h1 {\n                        color: #00ff88;\n                        margin-bottom: 10px;\n                    }\n                    p {\n                        color: #a0a6b8;\n                        line-height: 1.5;\n                    }\n                    .retry-btn {\n                        background: #00ff88;\n                        color: black;\n                        border: none;\n                        padding: 12px 24px;\n                        border-radius: 6px;\n                        font-weight: 600;\n                        cursor: pointer;\n                        margin-top: 20px;\n                    }\n                </style>\n            </head>\n            <body>\n                <div class="offline-container">\n                    <div class="offline-icon">ðŸ“¡</div>\n                    <h1>You\'re Offline</h1>\n                    <p>NutraSafe Admin needs an internet connection to load. Please check your connection and try again.</p>\n                    <button class="retry-btn" onclick="location.reload()">Retry</button>\n                </div>\n            </body>\n            </html>\n        ',{headers:{"Content-Type":"text/html"}})}}async function handleStaticResource(e){const n=await caches.open(STATIC_CACHE),t=await n.match(e);if(t)return t;try{const t=await fetch(e);return t.ok&&n.put(e,t.clone()),t}catch(e){return new Response("Resource not available offline",{status:503})}}function isStaticResource(e){const n=new URL(e.url).pathname;return n.endsWith(".css")||n.endsWith(".js")||n.endsWith(".png")||n.endsWith(".jpg")||n.endsWith(".jpeg")||n.endsWith(".gif")||n.endsWith(".svg")||n.endsWith(".ico")||n.endsWith(".woff")||n.endsWith(".woff2")}async function doBackgroundSync(){console.log("SW: Background sync triggered");const e=await getOfflineActions();for(const n of e)try{await fetch(n.url,n.options),await removeOfflineAction(n.id),console.log("SW: Synced offline action:",n.type)}catch(e){console.log("SW: Failed to sync action:",n.type,e)}}async function getOfflineActions(){return[]}async function removeOfflineAction(e){console.log("SW: Remove offline action:",e)}async function clearAllCaches(){const e=await caches.keys();return Promise.all(e.map(e=>caches.delete(e)))}async function handleRequest(e){const n=new URL(e.url);return n.pathname.startsWith("/api/")?handleApiRequest(e):n.pathname.endsWith(".html")||"/"===n.pathname?handlePageRequest(e):isStaticResource(e)?handleStaticResource(e):fetch(e)}self.addEventListener("install",e=>{console.log("SW: Installing..."),e.waitUntil(Promise.all([caches.open(STATIC_CACHE).then(e=>e.addAll(CRITICAL_RESOURCES)),self.skipWaiting()]))}),self.addEventListener("activate",e=>{console.log("SW: Activating..."),e.waitUntil(Promise.all([caches.keys().then(e=>Promise.all(e.filter(e=>e.startsWith("nutrasafe-")&&e!==CACHE_NAME&&e!==STATIC_CACHE&&e!==API_CACHE).map(e=>caches.delete(e)))),self.clients.claim()]))}),self.addEventListener("fetch",e=>{const{request:n}=e,t=new URL(n.url);t.pathname.startsWith("/api/")?e.respondWith(handleApiRequest(n)):t.pathname.endsWith(".html")||"/"===t.pathname?e.respondWith(handlePageRequest(n)):isStaticResource(n)?e.respondWith(handleStaticResource(n)):e.respondWith(fetch(n))}),self.addEventListener("sync",e=>{"background-sync"===e.tag&&e.waitUntil(doBackgroundSync())}),self.addEventListener("message",e=>{const{type:n,payload:t}=e.data;switch(n){case"SKIP_WAITING":self.skipWaiting();break;case"GET_VERSION":e.ports[0].postMessage({version:CACHE_NAME,timestamp:(new Date).toISOString()});break;case"CLEAR_CACHE":clearAllCaches().then(()=>{e.ports[0].postMessage({success:!0})});break;default:console.log("SW: Unknown message type:",n)}}),self.addEventListener("fetch",e=>{const n=performance.now();e.respondWith(handleRequest(e.request).then(t=>{const a=performance.now()-n;return a>1e3&&console.log(`SW: Slow request (${a}ms):`,e.request.url),t}))});